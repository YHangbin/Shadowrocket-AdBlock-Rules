name: Daily MITM Update

on:
  schedule:
    - cron: '0 1 * * *'  # UTC 1ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´ 9ç‚¹ï¼‰
  workflow_dispatch:     # æ”¯æŒæ‰‹åŠ¨è§¦å‘

permissions:
  contents: write        # ç¡®ä¿å¯ä»¥ push

jobs:
  update-mitm:
    runs-on: ubuntu-latest

    steps:
    # 1. Checkout å½“å‰ä»“åº“
    - name: Checkout repo
      uses: actions/checkout@v3
      with:
        fetch-depth: 0   # ç¡®ä¿å¯ä»¥ push
        ref: main        # å¦‚æœä½ ç”¨çš„æ˜¯ masterï¼Œè¯·æ”¹æˆ master

    # 2. ä¸‹è½½è¿œç¨‹ MITM æ–‡ä»¶ï¼ˆå¸¦ User-Agent + å¤‡ç”¨æºï¼‰
    - name: Download MITM file
      run: |
        PRIMARY_URL="https://whatshub.top/module/adultraplus.module"
        BACKUP_URL="https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/BanProgramAD.list"
        UA="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0 Safari/537.36"

        echo "ğŸ“¥ å°è¯•ä¸»æº: $PRIMARY_URL"
        if curl -L -A "$UA" -o mitm.module "$PRIMARY_URL" 2>/dev/null && [ -s mitm.module ]; then
          echo "âœ… ä¸»æºä¸‹è½½æˆåŠŸ"
        else
          echo "âš ï¸ ä¸»æºå¤±è´¥ï¼Œå°è¯•å¤‡ç”¨æº: $BACKUP_URL"
          if curl -L -A "$UA" -o mitm.module "$BACKUP_URL" 2>/dev/null && [ -s mitm.module ]; then
            echo "âœ… å¤‡ç”¨æºä¸‹è½½æˆåŠŸ"
          else
            echo "âŒ æ‰€æœ‰æºå‡å¤±è´¥ï¼Œé€€å‡º"
            exit 1
          fi
        fi

        # æ£€æŸ¥æ˜¯å¦ä¸‹è½½åˆ° HTML é”™è¯¯é¡µï¼ˆå¦‚ 403/404ï¼‰
        if head -n 10 mitm.module | grep -qi "<html\|<title\|403\|404\|forbidden\|not found"; then
          echo "âŒ æ£€æµ‹åˆ° HTML é”™è¯¯é¡µé¢ï¼Œå†…å®¹é¢„è§ˆï¼š"
          head -n 10 mitm.module
          exit 1
        fi

        echo "ğŸ“„ ä¸‹è½½æ–‡ä»¶é¢„è§ˆï¼ˆå‰ 20 è¡Œï¼‰ï¼š"
        head -n 20 mitm.module
        echo "ğŸ”¢ æ€»è¡Œæ•°: $(wc -l mitm.module)"

    # 3. æ¸…ç†æŒ‡å®š IPï¼ˆå¯è‡ªå®šä¹‰ï¼‰
    - name: Clean MITM file
      run: |
        # åœ¨è¿™é‡Œæ·»åŠ ä½ è¦åˆ é™¤çš„ IP æˆ–å…³é”®è¯
        REMOVE_IPS=("192.168.1.1" "10.0.0.1" "example.com")

        TMP_FILE=$(mktemp)
        while IFS= read -r line; do
          skip=false
          for ip in "${REMOVE_IPS[@]}"; do
            if [[ "$line" == *"$ip"* ]]; then
              skip=true
              break
            fi
          done
          if [ "$skip" = false ]; then
            echo "$line" >> "$TMP_FILE"
          fi
        done < mitm.module

        mv "$TMP_FILE" mitm.module

        # æ£€æŸ¥æ¸…ç†åæ˜¯å¦è¿˜æœ‰å†…å®¹
        if [ ! -s mitm.module ]; then
          echo "âŒ æ¸…ç†åæ–‡ä»¶ä¸ºç©ºï¼Œé€€å‡º"
          exit 1
        fi

        echo "ğŸ§¹ æ¸…ç†åé¢„è§ˆï¼ˆå‰ 20 è¡Œï¼‰ï¼š"
        head -n 20 mitm.module
        echo "ğŸ”¢ æ¸…ç†åæ€»è¡Œæ•°: $(wc -l mitm.module)"

    # 4. æäº¤å¹¶æ¨é€æ›´æ–°
    - name: Commit and push
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add mitm.module

        if git diff-index --quiet HEAD; then
          echo "âœ… æ–‡ä»¶æ— å˜æ›´ï¼Œæ— éœ€æäº¤"
        else
          git commit -m "Daily MITM update"
          git push origin HEAD
          echo "âœ… å·²æäº¤å¹¶æ¨é€æ›´æ–°"
        fi
