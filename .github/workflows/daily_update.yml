name: Filter from adultraplus.module

on:
  push:
    branches: [ main, master ]
    paths:
      - 'adultraplus.module'
  workflow_dispatch:

jobs:
  filter-ip:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Show original content
        run: |
          echo "Original file content:"
          head -10 adultraplus.module
          echo "..."
          echo "----------------------------------------"

      - name: Filter IP addresses and update description
        run: |
          python3 -c "
          import datetime
          
          # 要过滤的IP地址
          ips_to_remove = ['118.31.125.171', '112.124.203.116', '118.31.123.175']
          
          print('IPs to remove:', ips_to_remove)
          
          # 获取当前日期
          current_date = datetime.datetime.now().strftime('%Y-%m-%d')
          new_desc = f'#!desc={current_date}+剔除引发小宇宙报错的MITM中2个IP 地址'
          new_name = '#!name=FixBug_App启动页去广告ultra+'
          
          print(f'New description: {new_desc}')
          
          # 读取文件
          with open('adultraplus.module', 'r') as f:
              lines = f.readlines()
          
          # 处理每一行
          new_lines = []
          for line in lines:
              # 更新描述行
              if line.startswith('#!desc='):
                  print(f'Old description: {line.strip()}')
                  new_lines.append(new_desc + '\n')
              # 更新名称行
              elif line.startswith('#!name='):
                  print(f'Old name: {line.strip()}')
                  new_lines.append(new_name + '\n')
              # 处理 hostname 行
              elif 'hostname = ' in line and '%APPEND%' in line:
                  print(f'Processing hostname line: {line.strip()}')
                  
                  # 分离前缀和主机名列表
                  if 'hostname = %APPEND%' in line:
                      prefix = 'hostname = %APPEND% '
                      hostname_part = line.replace('hostname = %APPEND% ', '').strip()
                  else:
                      parts = line.split('=', 1)
                      prefix = parts[0] + '= '
                      hostname_part = parts[1].strip()
                  
                  # 分割主机名
                  hosts = hostname_part.split(',')
                  
                  print(f'Total hosts before filtering: {len(hosts)}')
                  
                  # 过滤掉指定的IP
                  filtered_hosts = [host for host in hosts if host.strip() not in ips_to_remove]
                  
                  print(f'Total hosts after filtering: {len(filtered_hosts)}')
                  print(f'Removed {len(hosts) - len(filtered_hosts)} hosts')
                  
                  # 重新组合
                  new_hostname_part = ','.join(filtered_hosts)
                  
                  # 重建行
                  new_line = prefix + new_hostname_part + '\n'
                  new_lines.append(new_line)
                  
                  print(f'New hostname line: {new_line.strip()}')
              else:
                  new_lines.append(line)
          
          # 写回文件
          with open('adultraplus.module', 'w') as f:
              f.writelines(new_lines)
          "

      - name: Show filtered result
        run: |
          echo "Updated file content:"
          head -10 adultraplus.module
          echo "..."
          echo "----------------------------------------"

      - name: Check for changes
        id: changes
        run: |
          git add adultraplus.module
          if git diff --cached --quiet; then
            echo "no_changes=true" >> $GITHUB_OUTPUT
          else
            echo "no_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit and push changes
        if: steps.changes.outputs.no_changes == 'false'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git commit -m "Auto-filter: Update description and remove specified IP addresses (118.31.125.171, 112.124.203.116, 118.31.123.175) from hostname in adultraplus.module"
          git push

      - name: No changes detected
        if: steps.changes.outputs.no_changes == 'true'
        run: |
          echo "No changes were needed - specified IP addresses not found in hostname list"
