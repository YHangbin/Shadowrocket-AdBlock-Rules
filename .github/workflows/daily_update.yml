name: Download File via Browser (Bypass Cloudflare)

on:
  schedule:
    - cron: '0 3 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  download-with-browser:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Playwright
        run: |
          npm init -y
          npm install -D playwright
          npx playwright install chromium

      - name: Create Download Script
        run: |
          mkdir -p modules
          cat > download.mjs << 'EOF'
          import { chromium } from 'playwright';

          (async () => {
            const browser = await chromium.launch();
            const context = await browser.newContext({
              userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36'
            });
            const page = await context.newPage();

            console.log('ğŸŒ Going to URL...');
            await page.goto('https://whatshub.top/module/adultraplus.module', {
              waitUntil: 'networkidle',
              timeout: 60000
            });

            // ç­‰å¾…å‡ ç§’ç¡®ä¿ Cloudflare éªŒè¯å®Œæˆ
            await page.waitForTimeout(8000);

            // è·å–é¡µé¢å†…å®¹ï¼ˆå¦‚æœæ˜¯æ–‡ä»¶ï¼Œä¼šç›´æ¥æ˜¾ç¤ºæ–‡æœ¬ï¼‰
            const content = await page.content();

            // åˆ¤æ–­æ˜¯å¦ä»æ˜¯éªŒè¯é¡µé¢
            if (content.includes('<title>Just a moment...</title>')) {
              console.error('âŒ Still on Cloudflare challenge page. Aborting.');
              process.exit(1);
            }

            // è·å– body çº¯æ–‡æœ¬ï¼ˆå‡è®¾æ–‡ä»¶æ˜¯æ–‡æœ¬æ ¼å¼ï¼‰
            const bodyText = await page.evaluate(() => document.body.innerText);

            // ä¿å­˜åˆ°æ–‡ä»¶
            require('fs').writeFileSync('modules/adultraplus.module', bodyText);

            await browser.close();
            console.log('âœ… File downloaded successfully.');
          })();
          EOF

      - name: Run Download Script
        run: node download.mjs
        continue-on-error: true  # å³ä½¿å¤±è´¥ä¹Ÿç»§ç»­ï¼Œé¿å…ä¸­æ–­åç»­æ­¥éª¤

      - name: Set Git Identity
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Commit and Push if Changed
        run: |
          git add modules/adultraplus.module
          if git status --porcelain | grep -q "modules/adultraplus.module"; then
            git commit -m "chore: update adultraplus.module via browser"
            git push
            echo "âœ… Pushed updated file."
          else
            echo "â„¹ï¸ No changes detected."
          fi
