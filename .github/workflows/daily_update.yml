name: Daily MITM Update (Python)

on:
  schedule:
    - cron: '0 1 * * *'  # 每天 UTC 1 点自动运行
  workflow_dispatch:      # 支持手动触发

jobs:
  update-mitm-python:
    runs-on: ubuntu-latest

    steps:
    # 1. Checkout 当前仓库
    - name: Checkout repo
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
        ref: main  # 改成你的默认分支

    # 2. 设置 Python
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"

    # 3. 下载并处理 MITM 文件
    - name: Download and clean MITM with Python
      run: |
        python - <<'EOF'
        import re
        import urllib.request
        import sys

        FILE_URL = "https://whatshub.top/module/adultraplus.module"
        LOCAL_FILE = "mitm.module"
        REMOVE_PATTERNS = [
            r"192\.168\.1\.1",
            r"10\.0\.0\.\d+"
        ]

        try:
            # 下载文件，支持重定向
            with urllib.request.urlopen(FILE_URL) as response:
                content_bytes = response.read()
                print(f"Downloaded {len(content_bytes)} bytes")
                content = content_bytes.decode("utf-8", errors="ignore")

            lines = content.splitlines()
            print(f"Total lines: {len(lines)}")
            print("Preview (前 20 行):")
            print("\n".join(lines[:20]))

            # 清理 IP / 正则
            cleaned_lines = []
            for line in lines:
                if any(re.search(pattern, line) for pattern in REMOVE_PATTERNS):
                    continue
                cleaned_lines.append(line)

            print(f"After cleaning: {len(cleaned_lines)} lines")
            print("Preview cleaned file (前 20 行):")
            print("\n".join(cleaned_lines[:20]))

            # 写入本地文件
            with open(LOCAL_FILE, "w", encoding="utf-8") as f:
                f.write("\n".join(cleaned_lines))

        except Exception as e:
            print("Error occurred:", e, file=sys.stderr)
            sys.exit(1)
        EOF

    # 4. 提交更新到当前仓库
    - name: Commit and push
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add mitm.module
        # 只在有改动时提交
        if git diff-index --quiet HEAD; then
          echo "No changes to commit"
        else
          git commit -m "Daily MITM update (Python)"
          git push origin HEAD
