- name: Download and clean MITM with Python
  run: |
    python - <<'EOF'
    import re
    import urllib.request
    import sys

    FILE_URL = "https://whatshub.top/module/adultraplus.module"
    LOCAL_FILE = "mitm.module"
    REMOVE_PATTERNS = [
        r"192\.168\.1\.1",
        r"10\.0\.0\.\d+"
    ]

    try:
        # 下载文件
        with urllib.request.urlopen(FILE_URL) as response:
            content_bytes = response.read()
            print(f"Downloaded {len(content_bytes)} bytes")
            content = content_bytes.decode("utf-8", errors="ignore")

        lines = content.splitlines()
        print(f"Total lines: {len(lines)}")
        print("Preview (前 20 行):")
        print("\n".join(lines[:20]))

        # 清理 IP/正则
        cleaned_lines = []
        for line in lines:
            if any(re.search(pattern, line) for pattern in REMOVE_PATTERNS):
                continue
            cleaned_lines.append(line)

        print(f"After cleaning: {len(cleaned_lines)} lines")
        print("Preview cleaned file (前 20 行):")
        print("\n".join(cleaned_lines[:20]))

        # 写入本地文件
        with open(LOCAL_FILE, "w", encoding="utf-8") as f:
            f.write("\n".join(cleaned_lines))

    except Exception as e:
        print("Error occurred:", e, file=sys.stderr)
        sys.exit(1)
    EOF
